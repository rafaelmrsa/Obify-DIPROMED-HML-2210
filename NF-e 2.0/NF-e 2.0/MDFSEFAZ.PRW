#INCLUDE "PROTHEUS.CH"
#INCLUDE "COLORS.CH"
#INCLUDE "TBICONN.CH"
/*/
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁPrograma  ЁXmlMdfSef Ё Autor Ё Katia                 Ё Data Ё02.04.2013Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤┘o ЁRdmake de exemplo para geracao do Manifesto Eletronico da   Ё╠╠
╠╠Ё          ЁSEFAZ - Versao 1.00                                         Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁRetorno   ЁString do MDFe                                              Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁParametrosЁExpC1: Tipo do MDFe                                         Ё╠╠
╠╠Ё          Ё       [1] Envio                                            Ё╠╠
╠╠Ё          Ё       [2] Encerramento                                     Ё╠╠
╠╠Ё          Ё       [3] Cancelamento                                     Ё╠╠
╠╠Ё          ЁExpC2: Filial de Origem                                     Ё╠╠
╠╠Ё          ЁExpC3: Numero da Viagem                                     Ё╠╠
╠╠Ё          ЁExpC4: Filial do Manifesto                                  Ё╠╠
╠╠Ё          ЁExpC5: Numero do Manifesto                                  Ё╠╠
╠╠цддддддддддедддддддддддддддбдддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё   DATA   Ё Programador   ЁManutencao efetuada                         Ё╠╠
╠╠цддддддддддедддддддддддддддедддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё               Ё                                            Ё╠╠
╠╠юддддддддддадддддддддддддддадддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
/*/
User Function XmlMdfSef()               

Local cString     := ""
Local nSerieMDF   := 0
Local aXMLMDFe    := {}
Local cDV         := ''
Local nMDF        := ''
Local cMDF        := ''
Local cChvAcesso  := ''
Local nCount      := 0 
Local cCodUF      := ''
Local cTpEmis     := ''
Local cUFIni      := ''
Local cUFFim      := ''
Local cCdMunIni	  := ''
Local cCidIni     := ''
Local cNFe        := ""
Local cTmsAntt    := SuperGetMv( "MV_TMSANTT", .F., .F. )
Local cCodVei     := ''
Local cAliasDTR   := ''
Local nX          := 0
Local nCapcM3     := 0 
Local cAliasDA4   := ''
Local cAliasDVB   := ''
Local cAliasDUD   := ''
Local cAliasDT6   := ''
Local lChvCTG     := DT6->(FieldPos('DT6_CHVCTG')) > 0
Local cFilDCAOld  := ''
Local cMunDCAOld  := ''
Local cObs		  := ''
Local cQuery      := ''
Local cAliasDTX   := ''
Local aAreaDTX    := {}         
Local cFilMan     := PARAMIXB[1]
Local cNumMan     := PARAMIXB[2]
Local cAmbiente   := PARAMIXB[3]
Local cVerAmb     := PARAMIXB[4]
Local cModalidade := PARAMIXB[5]
Local cEvento     := PARAMIXB[6]
Local cSerMan     := PARAMIXB[7]
Local cUFPer      := ""
Local cFilOri     := ""
Local cViagem     := "" 
Local cNumRom     := ""
Local cAliasDUN   := ""
Local cSeek       := ""                     
Local cAliasDIQ   := ""                     
Local cSeqIni     := StrZero(0,Len(DUN->DUN_SEQUEN))
Local cSeqFim     := StrZero(0,Len(DUN->DUN_SEQUEN))
Local nCont       := 0      
Local nQtdCte     := 0
Local cMdfeDoc    := SuperGetMV('MV_MDFEDOC',,'')
Local aTipoDoc    := Iif(!Empty(cMdfeDoc),Str2Arr(Upper(cMdfeDoc), ","),'')  //quebra em array por delimitador ","
Local lRet        := .T.
Local cSertms     := ''
Local lPercMDFe   := AliasInDic("DIQ")
Local aPercurso   := {}   
Local nPos        := 0
Local lDTX_SERMAN := DTX->(FieldPos("DTX_SERMAN")) > 0
Local nEst        := 0
Local cRota       := ""
Local cCNPJAntt    := SuperGetMv( "MV_CNPJANTT", .F., .F. )

//Rafael Moraes Rosa - 12/01/2023 - VARIAVEL
Local cEndEnt	:= ""
Local cCodMun	:= ""
Local cCidEnt	:= ""
Local cEstEnt	:= ""
Local cCEPEnt	:= ""
Local cBairEnt	:= ""
Local cCompEnt	:= ""

Private aUF       := {}

//Rafael Moraes Rosa - 12/01/2023 - INICIO
//dbSelectArea("SM0")

IF cEmpAnt+cFilAnt = '0101'

	SM0->(dbSeek("0104"))
		cEndEnt		:= SM0->M0_ENDENT
		cCodMun		:= SM0->M0_CODMUN
		cCidEnt		:= SM0->M0_CIDENT
		cEstEnt		:= SM0->M0_ESTENT
		cCEPEnt		:= SM0->M0_CEPENT
		cBairEnt	:= SM0->M0_BAIRENT
		cCompEnt	:= SM0->M0_COMPENT

ELSE
	SM0->(dbSeek(cEmpAnt+cFilAnt))
		cEndEnt		:= SM0->M0_ENDENT
		cCodMun		:= SM0->M0_CODMUN
		cCidEnt		:= SM0->M0_CIDENT
		cEstEnt		:= SM0->M0_ESTENT
		cCEPEnt		:= SM0->M0_CEPENT
		cBairEnt	:= SM0->M0_BAIRENT
		cCompEnt	:= SM0->M0_COMPENT

ENDIF
//SM0->(dbSkip())

SM0->(dbSeek(cEmpAnt+cFilAnt))

//Rafael Moraes Rosa - 12/01/2023 - FIM

//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁPreenchimento do Array de UF                                            Ё
//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
aAdd(aUF,{"RO","11"})
aAdd(aUF,{"AC","12"})
aAdd(aUF,{"AM","13"})
aAdd(aUF,{"RR","14"})
aAdd(aUF,{"PA","15"})
aAdd(aUF,{"AP","16"})
aAdd(aUF,{"TO","17"})
aAdd(aUF,{"MA","21"})
aAdd(aUF,{"PI","22"})
aAdd(aUF,{"CE","23"})
aAdd(aUF,{"RN","24"})
aAdd(aUF,{"PB","25"})
aAdd(aUF,{"PE","26"})
aAdd(aUF,{"AL","27"})
aAdd(aUF,{"MG","31"})
aAdd(aUF,{"ES","32"})
aAdd(aUF,{"RJ","33"})
aAdd(aUF,{"SP","35"})
aAdd(aUF,{"PR","41"})
aAdd(aUF,{"SC","42"})
aAdd(aUF,{"RS","43"})
aAdd(aUF,{"MS","50"})
aAdd(aUF,{"MT","51"})
aAdd(aUF,{"GO","52"})
aAdd(aUF,{"DF","53"})
aAdd(aUF,{"SE","28"})
aAdd(aUF,{"BA","29"})
aAdd(aUF,{"EX","99"})

If cEvento == "I" //-- Envio Manifesto
	If lDTX_SERMAN .And. Alltrim(cSerman)<>'0'
		cSeek :=  xFilial("DTX")+cFilMan+cNumMan+cSerman
	Else
		cSeek :=  xFilial("DTX")+cFilMan+cNumMan
	EndIf	
	//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
	//ЁPosiciona MDF                                                           Ё
	//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
	dbSelectArea("DTX")
	dbSetOrder(2)
	If dbSeek(cSeek)

		cFilOri := DTX->DTX_FILORI
		cViagem := DTX->DTX_VIAGEM
    	If DTX->(FieldPos("DTX_NUMROM")) > 0
			cNumRom	:= DTX->DTX_NUMROM
		EndIf 
		
		cSertms  := Posicione("DTQ",2,xFilial("DTQ")+cFilOri+cViagem,"DTQ_SERTMS")
				
		cString := ''
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Header do Arquivo XML                                           Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cString += '<MDFe xmlns="http://www.portalfiscal.inf.br/mdfe">'

		aAdd(aXMLMDFe,AllTrim(cString))
		
		//Rafael Moraes Rosa - 12/01/2023 - INICIO - LINHA COMENTADA
		/*		
		If aScan(aUF,{|x| x[1] ==  AllTrim(SM0->M0_ESTENT) }) != 0 // Confere se Uf do Emitente esta OK
			cCodUF := aUF[ aScan(aUF,{|x| x[1] == AllTrim(SM0->M0_ESTENT) }), 2]
		*/
		//Rafael Moraes Rosa - 12/01/2023 - INICIO - LINHA COMENTADA

		//Rafael Moraes Rosa - 12/01/2023 - INICIO - LINHA SUBSTITUIDA
		If aScan(aUF,{|x| x[1] ==  AllTrim(cEstEnt) }) != 0 // Confere se Uf do Emitente esta OK
			cCodUF := aUF[ aScan(aUF,{|x| x[1] == AllTrim(cEstEnt) }), 2]
		//Rafael Moraes Rosa - 12/01/2023 - FIM - LINHA SUBSTITUIDA

		Else
			cCodUF := ''
		EndIf                                                
				
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Formato de Impressao do MDF-e                                   Ё
		//Ё 1 - Normal                                                      Ё
		//Ё 2 - ContingЙncia                   								Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If cModalidade == '1'
			cTpEmis := '1'
		ElseIf cModalidade == '2'
			cTpEmis := '2'
		EndIf
				
		cDV := cTpEmis + Inverte(StrZero( val(PadR(DTX->DTX_MANIFE,9)), 8))
		
		If lDTX_SERMAN .And. !Empty(DTX->DTX_SERMAN)
	   		nSerieMDF := Val( AllTrim(DTX->DTX_SERMAN))
		EndIf 
		
		cChvAcesso := MDFCHVAC( cCodUF,;
							   ( SubStr(DToS(DTX->DTX_DATMAN),3, 2) +  SubStr(DToS(DTX->DTX_DATMAN),5, 2) ),;
							    AllTrim(SM0->M0_CGC),;
								 '58',;
								 StrZero( nSerieMDF, 3),;
								 StrZero( val(PadR(DTX->DTX_MANIFE,9)), 9),;
								 cDV)								 

		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Inicio dos Dados do MDFe                                        Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cDV := Inverte(StrZero( val(Padr(DTX->DTX_MANIFE,8)), 8))
		cNFe    := 'MDFe' + AllTrim(cChvAcesso)
		cString := ''
					
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Versao do MDF-e, de acordo com o parametro                      Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cString += '<infMDFe Id="MDFe' + AllTrim(cChvAcesso) + '" versao="' + cVerAmb + '">'
								
		aAdd(aXMLMDFe,AllTrim(cString))
					
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё TAG: IDE -- Identificacao do MDF-e                              Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Identificacao do Ambiente.                                      Ё
		//Ё 1 - Producao                                                    Ё
		//Ё 2 - Homologacao                                                 Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды                         
		cString:= ""
		cString += '<ide>'
		cString += '<cUF>'  + NoAcentoCte( cCodUF )	 + '</cUF>'
		cString += '<tpAmb>' + cAmbiente + '</tpAmb>'          		
		cString += '<tpEmit>1</tpEmit>'   
		cString += '<mod>58</mod>'               
		If lDTX_SERMAN .And. !Empty(DTX->DTX_SERMAN)   
			cString += '<serie>' + Alltrim(Str(nSerieMDF)) + '</serie>'
		Else
			cString += '<serie>' + StrZero( nSerieMDF, 1) + '</serie>'
		EndIf		
		cString += '<nMDF>'+ NoAcentoCte( cValtoChar( Val( AllTrim(DTX->DTX_MANIFE) ) ) ) + '</nMDF>'

		cMDF := Inverte(StrZero( val(DTX->DTX_MANIFE), 8))                                           
		
		cString += '<cMDF>'+ NoAcentoCte(cMDF) + '</cMDF>'
		
		cString += '<cDV>' + SubStr( AllTrim(cChvAcesso), Len( AllTrim(cChvAcesso) ), 1) + '</cDV>'

		cString += '<modal>1</modal>'  //Rodoviario
		
		cString += '<dhEmi>'+ SubStr(DToS(DTX->DTX_DATMAN), 1, 4) + "-";
							+ SubStr(DToS(DTX->DTX_DATMAN), 5, 2) + "-";
							+ SubStr(DToS(DTX->DTX_DATMAN), 7, 2) + "T";
							+ SubStr(AllTrim(DTX->DTX_HORMAN), 1, 2) + ":";
							+ SubStr(AllTrim(DTX->DTX_HORMAN), 3, 2) + ':00</dhEmi>'

		cString += '<tpEmis>' + cTpEmis + '</tpEmis>'

		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё Processo de Emissao do CT-e                                     Ё
		//Ё 0 - emissao com aplicativo do contribuinte                      Ё
		//Ё 3 - pelo contribuinte com aplicativo fornecido pelo Fisco       Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cString += '<procEmi>0</procEmi>'
		
		cString += '<verProc>' + cVerAmb + '</verProc>'
		
		cRota := Posicione("DTQ",2,xFilial("DTQ")+cFilOri+cViagem,"DTQ_ROTA")
		DA8->(DbSetOrder(1))
		If (DA8->(FieldPos("DA8_CDOMDF")) > 0) .And. DA8->(MsSeek(xFilial("DA8")+cRota)) 
			DUY->(DbSetOrder(1))			
			If 	!Empty(DA8->DA8_CDOMDF) .And. DUY->(MsSeek(xFilial("DUY")+DA8->DA8_CDOMDF)) 
				cCodUF 	:= aUF[ aScan(aUF,{|x| x[1] == AllTrim(DUY->DUY_EST) }), 2] 			
				cUFIni 	:= DUY->DUY_EST
				cCdMunIni	:= AllTrim(cCodUF) + AllTrim(DUY->DUY_CODMUN)
				cCidIni   	:= DUY->DUY_DESCRI
			EndIf
		EndIf                                     

		aAreaSM0 := SM0->(GetArea())
		If Empty(cUFIni) .Or. Empty(cCdMunIni) .Or. Empty(cCidIni)

			//Rafael Moraes Rosa - 12/01/2023 - INICIO - LINHA COMENTADA
			/*
			cUFIni 	:= Posicione("SM0",1,cEmpAnt+DTX->DTX_FILMAN,"M0_ESTENT")
			cCdMunIni	:= Posicione("SM0",1,cEmpAnt+DTX->DTX_FILMAN,"M0_CODMUN")
			cCidIni  	:= Posicione("SM0",1,cEmpAnt+DTX->DTX_FILMAN,"M0_CIDENT")
			*/
			//Rafael Moraes Rosa - 12/01/2023 - FIM - LINHA COMENTADA

			//Rafael Moraes Rosa - 12/01/2023 - INICIO - LINHA SUBSTITUIDA
			cUFIni 		:= Posicione("SM0",1,IIF(cEmpAnt+cFilAnt = "0101","0104",cEmpAnt+DTX->DTX_FILMAN),"M0_ESTENT")
			cCdMunIni	:= Posicione("SM0",1,IIF(cEmpAnt+cFilAnt = "0101","0104",cEmpAnt+DTX->DTX_FILMAN),"M0_CODMUN")
			cCidIni  	:= Posicione("SM0",1,IIF(cEmpAnt+cFilAnt = "0101","0104",cEmpAnt+DTX->DTX_FILMAN),"M0_CIDENT")
			//Rafael Moraes Rosa - 12/01/2023 - FIM - LINHA SUBSTITUIDA

		EndIf	      			
		
		//cUFFIm   := Posicione("SM0",1,cEmpAnt+DTX->DTX_FILDCA,"M0_ESTENT") //Rafael Moraes Rosa - 12/01/2023 - LINHA COMENTADA
		cUFFIm   := Posicione("SM0",1,IIF(cEmpAnt+cFilAnt = "0101","0104",cEmpAnt+DTX->DTX_FILDCA),"M0_ESTENT") //Rafael Moraes Rosa - 12/01/2023 - LINHA SUBSTITUIDA
		
		cString += '<UFIni>' + NoAcentoCte(cUFIni) + '</UFIni>' 
		
		// Verifica se И viagem de Entrega
		If cSertms = '3' .Or. (cSertms = '2' .And. DTX->DTX_FILDCA = cFilAnt) .Or. __lPyme

			// Busca ultimo doc sequenciado do manifesto posicionado
			// Para este tratamento И necessario que o manifesto tenha sido gerado por ESTADO.
			cAliasDUD := GetNextAlias()
			cQuery += "SELECT Max(DUD_SEQUEN) MAX_SEQUEN, DUD_CDRCAL "
			cQuery += "  FROM " + RetSQLName("DUD") + " DUD "
			cQuery += " WHERE DUD.DUD_FILIAL  = '"+xFilial("DUD")+"'"
			cQuery += "	  AND DUD.DUD_FILORI  = '"+cFilOri+"'"
    		If __lPyme 
				cQuery += "	  AND DUD.DUD_NUMROM  = '" + cNumRom + "'"	
			EndIf
			cQuery += "	  AND DUD.DUD_FILMAN  = '" + cFilMan + "'"
			cQuery += "	  AND DUD.DUD_MANIFE  = '" + cNumMan + "'"
			cQuery += "	  AND DUD.D_E_L_E_T_  = ' '"
			cQuery += " GROUP BY DUD_CDRCAL"

			cQuery := ChangeQuery(cQuery)
			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasDUD)		
			
			If !(cAliasDUD)->(Eof())
				
				// Em viagem de Entrega a UF Fim vem da regiao de Calculo
				cUFFIm   := Posicione("DUY",1, xFilial('DUY')+(cAliasDUD)->DUD_CDRCAL ,"DUY_EST")
			EndIf
						
		Else		
			// Em Viagem de Transferencia o descarregamento ocorre na mesma filial (SM0).
			//cUFFIm   := Posicione("SM0",1,cEmpAnt+DTX->DTX_FILDCA,"M0_ESTENT") //Rafael Moraes Rosa - 12/01/2023 - LINHA COMENTADA
			cUFFIm   := Posicione("SM0",1,IIF(cEmpAnt+cFilAnt = "0101","0104",cEmpAnt+DTX->DTX_FILDCA),"M0_ESTENT") //Rafael Moraes Rosa - 12/01/2023 - LINHA SUBSTITUIDA
		EndIf
		
		cString += '<UFFim>' + NoAcentoCte(cUFFIm) + '</UFFim>'   
		RestArea(aAreaSM0)

		cString += '<infMunCarrega>'  
		cString += '<cMunCarrega>' + NoAcentoCte(cCdMunIni) + '</cMunCarrega>'
		cString += '<xMunCarrega>' + NoAcentoCte(cCidIni) + '</xMunCarrega>'
		cString += '</infMunCarrega>'     
		                                                         
		cUFPer:= "'" + AllTrim(DTX->DTX_FILMAN) + "','" + AllTrim(DTX->DTX_FILDCA) + "'"  //Uf Inicial e Final do Manifesto 
	
		If !__lPyme
		   	If cUFIni<>cUFFIm                               
			   	DTQ->(DbSetOrder(2))
				If DTQ->(MsSeek(xFilial("DTQ")+DTX->DTX_FILORI+DTX->DTX_VIAGEM))   
					
					// Verifica se utiliza Percursos do MDF-e, caso contrario verifica Regioes da Rota
					If lPercMDFe
		
						cAliasDIQ := GetNextAlias()
						cQuery := " SELECT DIQ_EST "
						cQuery += "   FROM " + RetSqlName("DIQ")
						cQuery += "  WHERE DIQ_FILIAL = '" + xFilial('DIQ') + "' "
						cQuery += "    AND DIQ_ROTA = '" + DTQ->DTQ_ROTA + "' "  
						cQuery += "    AND D_E_L_E_T_ = ' ' "
						cQuery += "  ORDER BY DIQ_SEQUEN "
						cQuery := ChangeQuery(cQuery)
						dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasDIQ)
						
						While !(cAliasDIQ)->(Eof())
						
							If (cAliasDIQ)->DIQ_EST <> cUFIni
								 Aadd( aPercurso, (cAliasDIQ)->DIQ_EST )							
							EndIf
							
							// /inclui ultimo estado do percursos referente ao manifesto atual
							If (cAliasDIQ)->DIQ_EST == cUFFim
								Exit
							EndIf
							
							(cAliasDIQ)->(DbSkip())
						EndDo						
						(cAliasDIQ)->(DbCloseArea())
		
					EndIf
					
					If DTQ->DTQ_SERTMS == StrZero(2,Len(DTQ->DTQ_SERTMS));
							.And. Len(aPercurso) == 0
						
						cAliasDUN := GetNextAlias()
						cQuery := " SELECT DUN_FILDES, DUN_CDRDES "
						cQuery += "   FROM " + RetSqlName("DUN") 
						cQuery += " WHERE DUN_FILIAL = '" + xFilial('DUN') + "' "
						cQuery += "   AND DUN_ROTEIR = '" + DTQ->DTQ_ROTA + "' "  
						cQuery += "   AND D_E_L_E_T_ = ' ' "
						cQuery += " ORDER BY DUN_ROTEIR, DUN_SEQUEN "
						cQuery := ChangeQuery(cQuery)
						dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasDUN)		
						While (cAliasDUN)->(!Eof())                    
							DUY->(DbSetOrder(1))
							If DUY->(MsSeek(xFilial("DUY")+(cAliasDUN)->DUN_CDRDES))
								If DUY->DUY_EST <> cUFIni .And. DUY->DUY_EST <> cUFFim
									Aadd( aPercurso, DUY->DUY_EST )
								EndIf
							EndIf
							(cAliasDUN)->(DbSkip())
						EndDo						
						(cAliasDUN)->(DbCloseArea())
						
					EndIf
					
					If Len(aPercurso) > 0	            
						For nCount:= 1 to Len(aPercurso)
							If cUFFim <>aPercurso[nCount]
								If nCount <= 25
									cString += '<infPercurso>' 
									cString += '<UFPer>' + NoAcentoCte( aPercurso[nCount] ) + '</UFPer>'
									cString += '</infPercurso>'
								EndIf
							Else 
								nCount := Len(aPercurso)
							EndIf						
						Next nCount
					EndIf
				EndIf
			EndIf                   
			
		Else  // Caso seja serie 3      
			If AliasInDic("DJ1")
			   	If cUFIni<>cUFFIm                              
			
					cAliasDJ1 := GetNextAlias()
					cQuery := " SELECT DJ1_EST "
					cQuery += "   FROM " + RetSqlName("DJ1")
					cQuery += "  WHERE DJ1_FILIAL = '" + xFilial('DJ1') + "' "
					cQuery += "    AND DJ1_NUMROM = '" + cNumRom + "' "  
					cQuery += "    AND D_E_L_E_T_ = ' ' "
					cQuery += "  ORDER BY DJ1_SEQUEN "
					cQuery := ChangeQuery(cQuery)
					dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasDJ1)
					
					While !(cAliasDJ1)->(Eof())
					
						If (cAliasDJ1)->DJ1_EST <> cUFIni
							If ( nPos:= Ascan(aPercurso, { | x | x == (cAliasDJ1)->DJ1_EST } ) ) == 0   //Nao repetir a mesma UF 
								Aadd( aPercurso, (cAliasDJ1)->DJ1_EST )
							EndIf
							
						EndIf
						
						// /inclui ultimo estado do percursos referente ao manifesto atual
						If (cAliasDJ1)->DJ1_EST == cUFFim
							Exit
						EndIf
						
						(cAliasDJ1)->(DbSkip())
					EndDo						
					(cAliasDJ1)->(DbCloseArea())
			
					If Len(aPercurso) > 0	            
						For nCount:= 1 to Len(aPercurso)
							If cUFFim <>aPercurso[nCount]
								If nCount <= 25
									cString += '<infPercurso>' 
									cString += '<UFPer>' + NoAcentoCte( aPercurso[nCount] ) + '</UFPer>'
									cString += '</infPercurso>'
								EndIf
							Else 
								nCount := Len(aPercurso)
							EndIf						
						Next nCount
					EndIf
				EndIf                   
			Else
				MsgAlert("Favor rodar o compatibilizador TMS11R159")
			EndIf
		EndIf                   
		cAliasDTR := GetNextAlias()                           
		                                              
		cQuery    := "SELECT DTR_DATINI, DTR_HORINI  "
		cQuery    += " FROM " + RetSqlName("DTR")+" DTR "
		cQuery    += " WHERE DTR_FILIAL = '"+xFilial('DTR')+"'"
		cQuery    += "   AND DTR_FILORI = '"+DTX->DTX_FILORI+"'"
		cQuery    += "   AND DTR_VIAGEM = '"+DTX->DTX_VIAGEM+"'"
		cQuery    += "   AND DTR.D_E_L_E_T_ = ' '"
		cQuery    := ChangeQuery(cQuery)
		dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasDTR,.F.,.T.)

		If !Empty((cAliasDTR)->DTR_DATINI) 
			cString += '<dhIniViagem>'+ SubStr((cAliasDTR)->DTR_DATINI, 1, 4) + "-";
								+ SubStr((cAliasDTR)->DTR_DATINI, 5, 2) + "-";
								+ SubStr((cAliasDTR)->DTR_DATINI, 7, 2) + "T";
								+ SubStr(AllTrim((cAliasDTR)->DTR_HORINI), 1, 2) + ":";
								+ SubStr(AllTrim((cAliasDTR)->DTR_HORINI), 3, 2) + ':00</dhIniViagem>'
		EndIf
		
		(cAliasDTR)->(dbCloseArea())
        cString += '</ide>'
		aAdd(aXMLMDFe,AllTrim(cString))
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё TAG: Emit -- Identificacao do Emitente do Manifesto              Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cString := ''
		cString += '<emit>'
		cString += '<CNPJ>' + NoPontos(SM0->M0_CGC) + '</CNPJ>'
		
		If (AllTrim(SM0->M0_INSC) == 'ISENTO')
			cString += '<IE>ISENTO</IE>'
		Else
			cString += '<IE>' + NoPontos(SM0->M0_INSC) + '</IE>'
		EndIf
		
		cString += '<xNome>' + NoAcentoCte(SubStr(SM0->M0_NOMECOM,1,60)) + '</xNome>'
		cString += '<xFant>' + NoAcentoCte(SM0->M0_NOME) + '</xFant>'
		cString += '<enderEmit>'

		//Rafael Moraes Rosa - 12/01/2023 - INICIO - LINHA COMENTADA
		/*
		cString += '<xLgr>' + NoAcentoCte(FisGetEnd(SM0->M0_ENDENT)[1]) + '</xLgr>'
		cString += '<nro>'  + Iif(FisGetEnd(SM0->M0_ENDENT)[2]<>0, AllTrim(cValtoChar( FisGetEnd(SM0->M0_ENDENT)[2])),"S/N") + '</nro>'
		If !Empty(NoAcentoCte(FisGetEnd(SM0->M0_ENDENT)[4]))
			cString += '<xCpl>' + NoAcentoCte(FisGetEnd(SM0->M0_ENDENT)[4]) + '</xCpl>'
		*/
		//Rafael Moraes Rosa - 12/01/2023 - FIM - LINHA COMENTADA

		//Rafael Moraes Rosa - 12/01/2023 - INICIO - LINHA SUBSTITUIDA
		cString += '<xLgr>' + NoAcentoCte(FisGetEnd(cEndEnt)[1]) + '</xLgr>'
		cString += '<nro>'  + Iif(FisGetEnd(cEndEnt)[2]<>0, AllTrim(cValtoChar( FisGetEnd(cEndEnt)[2])),"S/N") + '</nro>'
		If !Empty(NoAcentoCte(FisGetEnd(cEndEnt)[4]))
			cString += '<xCpl>' + NoAcentoCte(FisGetEnd(cEndEnt)[4]) + '</xCpl>'
		//Rafael Moraes Rosa - 12/01/2023 - FIM - LINHA SUBSTITUIDA

		EndIf
		//If Empty(AllTrim(SM0->M0_BAIRENT)) //Rafael Moraes Rosa - 12/01/2023 - LINHA COMENTADA
		If Empty(AllTrim(cBairEnt))
			cString += '<xBairro>BAIRRO NAO CADASTRADO</xBairro>'
		Else
			//cString += '<xBairro>' + NoAcentoCte( SM0->M0_BAIRENT ) + '</xBairro>'
			cString += '<xBairro>' + NoAcentoCte( cBairEnt ) + '</xBairro>' //Rafael Moraes Rosa - 12/01/2023 - LINHA SUBSTITUIDA
		EndIf
		
		//Rafael Moraes Rosa - 12/01/2023 - INICIO - LINHA COMENTADA
		/*
		cString += '<cMun>' + NoAcentoCte( SM0->M0_CODMUN ) + '</cMun>'
		cString += '<xMun>' + NoAcentoCte( SM0->M0_CIDENT ) + '</xMun>'
		cString += '<CEP>'  + NoAcentoCte( SM0->M0_CEPENT ) + '</CEP>'
		cString += '<UF>'   + NoAcentoCte( SM0->M0_ESTENT ) + '</UF>'
		*/
		//Rafael Moraes Rosa - 12/01/2023 - FIM - LINHA COMENTADA

		//Rafael Moraes Rosa - 12/01/2023 - INICIO - LINHA SUBSTITUIDA
		cString += '<cMun>' + NoAcentoCte( cCodMun ) + '</cMun>'
		cString += '<xMun>' + NoAcentoCte( cCidEnt ) + '</xMun>'
		cString += '<CEP>'  + NoAcentoCte( cCEPEnt ) + '</CEP>'
		cString += '<UF>'   + NoAcentoCte( cEstEnt ) + '</UF>'
		//Rafael Moraes Rosa - 12/01/2023 - FIM - LINHA SUBSTITUIDA

		If !Empty (NoPontos(SM0->M0_TEL))
			cString += '<fone>5511'+Right(AllTrim(SM0->M0_TEL),8)+'</fone>'
		EndIf
		cString += '</enderEmit>'
		cString += '</emit>'

		aAdd(aXMLMDFe,AllTrim(cString))

		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё TAG: InfModal -- Informacoes do modal Rodoviario                Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cString:= ""
		cString += '<infModal versaoModal="'+cVerAmb+'">'
		cString += '<rodo>'		
		cString += '<RNTRC>' + SubStr(AllTrim(cTmsAntt),1,8) + '</RNTRC>'	
		
		If __lPyme // Utilizado no Serie 3
			//INICIO            
			cAliasDYB := GetNextAlias()                           
			                                              
			cQuery    := "SELECT DYB_CODVEI, DYB_CODRB1, DYB_CODRB2, DYB_CODMOT  "
			cQuery    += " FROM " + RetSqlName("DYB")+" DYB "
			cQuery    += " WHERE DYB_FILIAL = '"+xFilial('DYB')+"'"
			cQuery    += "   AND DYB_NUMROM = '"+cNumRom+"'"
			cQuery    += "   AND DYB.D_E_L_E_T_ = ' '"
			cQuery    := ChangeQuery(cQuery)
			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasDYB,.F.,.T.)
			If (cAliasDYB)->(!Eof())
			
				cCodVei:= ''
				For nX := 1 To 3                                              
					If nX == 1                                                
						cCodVei := (cAliasDYB)->DYB_CODVEI
					ElseIf nX == 2
						If !Empty((cAliasDYB)->DYB_CODRB1)
							cCodVei := (cAliasDYB)->DYB_CODRB1
						Else
							Exit
						EndIf
					ElseIf !Empty((cAliasDYB)->DYB_CODRB2)
						cCodVei := (cAliasDYB)->DYB_CODRB2
					Else
						Exit
					EndIf
					
					cAliasDA3 := GetNextAlias()
					cQuery := ""
					cQuery += " SELECT DA3_COD   , DA3_PLACA , DA3_RENAVA, DA3_TARA  ,DA3_CAPACM, DA3_FROVEI, " + CRLF
					cQuery += "        DA3_ESTPLA, DA3_CODFOR, DA3_LOJFOR, DUT_TIPROD, DUT_TIPCAR, "            + CRLF
					cQuery += "        DA3_ALTINT, DA3_LARINT, DA3_COMINT, DA3_RENAVA, "                         + CRLF
					cQuery += "        A2_CGC    , A2_NOME   , A2_INSCR  , A2_EST    , A2_TIPO  , A2_RNTRC,    " + CRLF
					cQuery += "        A2_TPRNTRC, A2_EQPTAC     " + CRLF
					cQuery += " FROM " + RetSqlName("DA3") + " DA3 " + CRLF
	
					cQuery += " INNER JOIN " + RetSqlName("DUT") + " DUT " + CRLF
					cQuery += "   ON DUT.DUT_TIPVEI = DA3.DA3_TIPVEI " + CRLF
					cQuery += "   AND DUT.D_E_L_E_T_ = ' ' " + CRLF
	
					cQuery += " INNER JOIN " + RetSqlName("SA2") + " SA2 ON " + CRLF
					cQuery += "           SA2.A2_COD    = DA3.DA3_CODFOR AND " + CRLF
					cQuery += "           SA2.A2_LOJA   = DA3.DA3_LOJFOR AND " + CRLF
					cQuery += "           SA2.D_E_L_E_T_= '' " + CRLF
	
					cQuery += " WHERE DA3.DA3_FILIAL = '"+xFilial("DA3")+"'" + CRLF
					cQuery += "   AND DA3.DA3_COD    = '"+cCodVei+"'"        + CRLF
					cQuery += "   AND DA3.D_E_L_E_T_ = ' '"                  + CRLF
					cQuery += "   AND DUT.DUT_FILIAL = '"+xFilial('DUT')+"'" + CRLF
					cQuery += "   AND SA2.A2_FILIAL  = '"+xFilial('SA2')+"'" + CRLF
					cQuery := ChangeQuery(cQuery)
					dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasDA3,.F.,.T.)
	
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//Ё TAG: Veic -- Tag com informacoes do veiculo                     Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If nX == 1
						cString += '<veicTracao>'
					Else
						cString += '<veicReboque>'
					EndIf
						
					cString += '<cInt>'    + NoAcentoCte((cAliasDA3)->DA3_COD)    + '</cInt>'
					cString += '<placa>'   + NoAcentoCte((cAliasDA3)->DA3_PLACA)  + '</placa>'
					If !Empty((cAliasDA3)->DA3_RENAVA)
						cString += '<RENAVAM>' + NoAcentoCte((cAliasDA3)->DA3_RENAVA) + '</RENAVAM>'				
					EndIf
					cString += '<tara>'    + ConvType(((cAliasDA3)->DA3_TARA) 	, 6,0, .T.)    + '</tara>'
					cString += '<capKG>'   + ConvType(((cAliasDA3)->DA3_CAPACM) , 6, 0, .T.) + '</capKG>'
					//Converte Valor da capacidade em KG para M3
					nCapcM3 := Round((cAliasDA3)->DA3_ALTINT * (cAliasDA3)->DA3_LARINT * (cAliasDA3)->DA3_COMINT,0)
					cString += '<capM3>'   + ConvType((nCapcM3) , 3, 0, .T.) + '</capM3>'
	
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//Ё TAG: Prop -- Se o veiculo for de terceiros, preencher tags com  Ё
					//Ё informacoes do proprietАrio                                     Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If (cAliasDA3)->DA3_FROVEI <> '1'
						cString += '<prop>'
						If Len(Alltrim((cAliasDA3)->A2_CGC)) > 11
							cString += '<CNPJ>'	+ NoAcentoCte( (cAliasDA3)->A2_CGC )	+ '</CNPJ>'
						Else
							cString += '<CPF>'	+ NoAcentoCte( (cAliasDA3)->A2_CGC )	+ '</CPF>'
						EndIf
						
						If !Empty((cAliasDA3)->A2_RNTRC)
							cString += '<RNTRC>' + StrZero(Val(AllTrim((cAliasDA3)->A2_RNTRC)),8) + '</RNTRC>'
						EndIf
						
						cString += '<xNome>'+ NoAcentoCte((cAliasDA3)->A2_NOME) + '</xNome>'
						
						If Empty((cAliasDA3)->A2_INSCR) .Or. 'ISENT' $ Upper(AllTrim((cAliasDA3)->A2_INSCR))
							cString += '<IE></IE>'
						Else
							cString += '<IE>' + NoPontos((cAliasDA3)->A2_INSCR) + '</IE>'
						EndIf	
						
						cString += '<UF>'		+ NoAcentoCte( (cAliasDA3)->A2_EST )		+ '</UF>'
						
						If ((cAliasDA3)->A2_TPRNTRC = '1' .OR. (cAliasDA3)->A2_EQPTAC = '1') .And. (cAliasDA3)->DA3_FROVEI = '3'  //TAC Agregado 
							cString += '<tpProp>0</tpProp>'
						ElseIf( (cAliasDA3)->A2_TPRNTRC = '1' .OR. (cAliasDA3)->A2_EQPTAC = '1') .And. (cAliasDA3)->DA3_FROVEI = '2'  //TAC Independente
							cString += '<tpProp>1</tpProp>'
						Else //Outros
							cString += '<tpProp>2</tpProp>'
						EndIf
						
						cString += '</prop>'
					EndIf
	                     
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//Ё TAG: Condutor -- Condutor do Veiculo                            Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If nX == 1
						cAliasDA4 := GetNextAlias()
						cQuery := " SELECT DA4_COD,DA4_NOME,DA4_CGC "
						cQuery += CRLF+" FROM " + RetSqlName("DA4") + " DA4 "

						cQuery += CRLF+ " WHERE DA4_FILIAL     = '" + xFilial("DA4") + "' AND "
						cQuery += CRLF+ "       DA4.DA4_COD    = '" + (cAliasDYB)->DYB_CODMOT + "' AND "
						cQuery += CRLF+ "       DA4.D_E_L_E_T_ = '' "
						cQuery := ChangeQuery(cQuery)
						dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasDA4,.F.,.T.)
	
						While (cAliasDA4)->(!Eof())
							cString += '<condutor>'
							cString +=   '<xNome>' + NoAcentoCte((cAliasDA4)->DA4_NOME) +'</xNome>
							cString +=   '<CPF>'   + AllTrim((cAliasDA4)->DA4_CGC) +'</CPF>'
							cString += '</condutor>'
							(cAliasDA4)->(dbSkip())
						EndDo
						(cAliasDA4)->(dbCloseArea())
						cString +=   '<tpRod>'   + AllTrim((cAliasDA3)->DUT_TIPROD) +'</tpRod>'
						
					EndIf		
					
					cString +=   '<tpCar>'   + AllTrim((cAliasDA3)->DUT_TIPCAR) +'</tpCar>'
					cString +=   '<UF>'   + AllTrim((cAliasDA3)->DA3_ESTPLA) +'</UF>'
					
					
					If nX == 1
						cString += '</veicTracao>'
					Else
						cString += '</veicReboque>'
					EndIf
		                                  
				Next nX			
			EndIf
			(cAliasDYB)->(dbCloseArea())			

			//FIM
		Else // Utilizado no Serie T		
			cAliasDTR := GetNextAlias()                           
			                                              
			If DTR->(FieldPos('DTR_CIOT')) > 0
				cQuery    := "SELECT DTR_CODVEI, DTR_CODRB1, DTR_CODRB2, DTR_CIOT, DTR_ITEM  "
			Else                                                          
				cQuery    := "SELECT DTR_CODVEI, DTR_CODRB1, DTR_CODRB2, DTR_ITEM  "
			EndIf	
			cQuery    += " FROM " + RetSqlName("DTR")+" DTR "
			cQuery    += " WHERE DTR_FILIAL = '"+xFilial('DTR')+"'"
			cQuery    += "   AND DTR_FILORI = '"+DTX->DTX_FILORI+"'"
			cQuery    += "   AND DTR_VIAGEM = '"+DTX->DTX_VIAGEM+"'"
			cQuery    += "   AND DTR.D_E_L_E_T_ = ' '"
			cQuery    := ChangeQuery(cQuery)
			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasDTR,.F.,.T.)
			If (cAliasDTR)->(!Eof())
			
				cCodVei:= ''
				For nX := 1 To 3                                              
					If nX == 1                                                
						If DTR->(FieldPos('DTR_CIOT')) > 0 .And. !Empty((cAliasDTR)->DTR_CIOT)
							cString += '<CIOT>' + SubStr(AllTrim((cAliasDTR)->DTR_CIOT),1,12) + '</CIOT>'			
						EndIf                                    
						cCodVei := (cAliasDTR)->DTR_CODVEI
					ElseIf nX == 2
						If !Empty((cAliasDTR)->DTR_CODRB1)
							cCodVei := (cAliasDTR)->DTR_CODRB1
						Else
							Exit
						EndIf
					ElseIf !Empty((cAliasDTR)->DTR_CODRB2)
						cCodVei := (cAliasDTR)->DTR_CODRB2
					Else
						Exit
					EndIf
					
					cAliasDA3 := GetNextAlias()
					cQuery := ""
					cQuery += " SELECT DA3_COD   , DA3_PLACA , DA3_RENAVA, DA3_TARA  ,DA3_CAPACM, DA3_FROVEI, " + CRLF
					cQuery += "        DA3_ESTPLA, DA3_CODFOR, DA3_LOJFOR, DUT_TIPROD, DUT_TIPCAR, "            + CRLF
					cQuery += "        DA3_ALTINT, DA3_LARINT, DA3_COMINT, DA3_RENAVA, "                         + CRLF
					cQuery += "        A2_CGC    , A2_NOME   , A2_INSCR  , A2_EST    , A2_TIPO  , A2_RNTRC,    " + CRLF
					cQuery += "        A2_TPRNTRC, A2_EQPTAC     " + CRLF
					cQuery += " FROM " + RetSqlName("DA3") + " DA3 " + CRLF
	
					cQuery += " INNER JOIN " + RetSqlName("DUT") + " DUT " + CRLF
					cQuery += "   ON DUT.DUT_TIPVEI = DA3.DA3_TIPVEI " + CRLF
					cQuery += "   AND DUT.D_E_L_E_T_ = ' ' " + CRLF
	
					cQuery += " INNER JOIN " + RetSqlName("SA2") + " SA2 ON " + CRLF
					cQuery += "           SA2.A2_COD    = DA3.DA3_CODFOR AND " + CRLF
					cQuery += "           SA2.A2_LOJA   = DA3.DA3_LOJFOR AND " + CRLF
					cQuery += "           SA2.D_E_L_E_T_= '' " + CRLF
	
					cQuery += " WHERE DA3.DA3_FILIAL = '"+xFilial("DA3")+"'" + CRLF
					cQuery += "   AND DA3.DA3_COD    = '"+cCodVei+"'"        + CRLF
					cQuery += "   AND DA3.D_E_L_E_T_ = ' '"                  + CRLF
					cQuery += "   AND DUT.DUT_FILIAL = '"+xFilial('DUT')+"'" + CRLF
					cQuery += "   AND SA2.A2_FILIAL  = '"+xFilial('SA2')+"'" + CRLF
					cQuery := ChangeQuery(cQuery)
					dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasDA3,.F.,.T.)
	
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//Ё TAG: Veic -- Tag com informacoes do veiculo                     Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If nX == 1
						cString += '<veicTracao>'
					Else
						cString += '<veicReboque>'
					EndIf
						
					cString += '<cInt>'    + NoAcentoCte((cAliasDA3)->DA3_COD)    + '</cInt>'
					cString += '<placa>'   + NoAcentoCte((cAliasDA3)->DA3_PLACA)  + '</placa>'
					If !Empty((cAliasDA3)->DA3_RENAVA)
						cString += '<RENAVAM>' + NoAcentoCte((cAliasDA3)->DA3_RENAVA) + '</RENAVAM>'				
					EndIf
					cString += '<tara>'    + ConvType(((cAliasDA3)->DA3_TARA) 	, 6,0, .T.)    + '</tara>'
					cString += '<capKG>'   + ConvType(((cAliasDA3)->DA3_CAPACM) , 6, 0, .T.) + '</capKG>'
					//Converte Valor da capacidade em KG para M3
					nCapcM3 := Round((cAliasDA3)->DA3_ALTINT * (cAliasDA3)->DA3_LARINT * (cAliasDA3)->DA3_COMINT,0)
					cString += '<capM3>'   + ConvType((nCapcM3) , 3, 0, .T.) + '</capM3>'
	
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//Ё TAG: Prop -- Se o veiculo for de terceiros, preencher tags com  Ё
					//Ё informacoes do proprietАrio                                     Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If (cAliasDA3)->DA3_FROVEI <> '1'
						cString += '<prop>'
						If Len(Alltrim((cAliasDA3)->A2_CGC)) > 11
							cString += '<CNPJ>'	+ NoAcentoCte( (cAliasDA3)->A2_CGC )	+ '</CNPJ>'
						Else
							cString += '<CPF>'	+ NoAcentoCte( (cAliasDA3)->A2_CGC )	+ '</CPF>'
						EndIf
						
						If !Empty((cAliasDA3)->A2_RNTRC)
							cString += '<RNTRC>' + StrZero(Val(AllTrim((cAliasDA3)->A2_RNTRC)),8) + '</RNTRC>'
						EndIf
						
						cString += '<xNome>'+ NoAcentoCte((cAliasDA3)->A2_NOME) + '</xNome>'
						
						If Empty((cAliasDA3)->A2_INSCR) .Or. 'ISENT' $ Upper(AllTrim((cAliasDA3)->A2_INSCR))
							cString += '<IE></IE>'
						Else
							cString += '<IE>' + NoPontos((cAliasDA3)->A2_INSCR) + '</IE>'
						EndIf	
						
						cString += '<UF>'		+ NoAcentoCte( (cAliasDA3)->A2_EST )		+ '</UF>'
						
						If ((cAliasDA3)->A2_TPRNTRC = '1' .OR. (cAliasDA3)->A2_EQPTAC = '1') .And. (cAliasDA3)->DA3_FROVEI = '3'  //TAC Agregado 
							cString += '<tpProp>0</tpProp>'
						ElseIf( (cAliasDA3)->A2_TPRNTRC = '1' .OR. (cAliasDA3)->A2_EQPTAC = '1') .And. (cAliasDA3)->DA3_FROVEI = '2'  //TAC Independente
							cString += '<tpProp>1</tpProp>'
						Else //Outros
							cString += '<tpProp>2</tpProp>'
						EndIf
						
						cString += '</prop>'
					EndIf
	                     
					//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
					//Ё TAG: Condutor -- Condutor do Veiculo                            Ё
					//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
					If nX == 1
						cAliasDA4 := GetNextAlias()
						cQuery := " SELECT DA4_COD,DA4_NOME,DA4_CGC "
						cQuery += CRLF+" FROM " + RetSqlName("DA4") + " DA4 "
		        	
						cQuery += CRLF+" INNER JOIN " + RetSqlName("DUP") + " DUP ON "
						cQuery += CRLF+"        DUP.DUP_CODMOT = DA4.DA4_COD AND "
						cQuery += CRLF+"        DUP.D_E_L_E_T_ = '' "
	
						cQuery += CRLF+ " WHERE DA4_FILIAL     = '" + xFilial("DA4") + "' AND "
						cQuery += CRLF+ "       DUP.DUP_FILIAL = '" + xFilial("DUP") + "' AND "
						cQuery += CRLF+ "       DUP_FILORI     = '" + DTX->DTX_FILORI + "' AND "
						cQuery += CRLF+ "       DUP_VIAGEM     = '" + DTX->DTX_VIAGEM + "' AND "
						cQuery += CRLF+ "       DUP_ITEDTR     = '" + (cAliasDTR)->DTR_ITEM + "' AND "
						cQuery += CRLF+ "       DA4.D_E_L_E_T_ = '' "
						cQuery := ChangeQuery(cQuery)
						dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasDA4,.F.,.T.)
	
						While (cAliasDA4)->(!Eof())
							cString += '<condutor>'
							cString +=   '<xNome>' + NoAcentoCte((cAliasDA4)->DA4_NOME) +'</xNome>
							cString +=   '<CPF>'   + AllTrim((cAliasDA4)->DA4_CGC) +'</CPF>'
							cString += '</condutor>'
							(cAliasDA4)->(dbSkip())
						EndDo
						(cAliasDA4)->(dbCloseArea())
						cString +=   '<tpRod>'   + AllTrim((cAliasDA3)->DUT_TIPROD) +'</tpRod>'
						
					EndIf		
					
					cString +=   '<tpCar>'   + AllTrim((cAliasDA3)->DUT_TIPCAR) +'</tpCar>'
					cString +=   '<UF>'   + AllTrim((cAliasDA3)->DA3_ESTPLA) +'</UF>'
					
					
					If nX == 1
						cString += '</veicTracao>'
					Else
						cString += '</veicReboque>'
					EndIf
		                                  
				Next nX			
			EndIf
			(cAliasDTR)->(dbCloseArea())
		EndIf

		cString += '</rodo>'
		cString += '</infModal>'                           
		
		aAdd(aXMLMDFe,AllTrim(cString)) 
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё TAG: InfDoc -- Informacoes dos Doctos Fiscais vinculados ao Manifesto Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		
		cString  := ""
		cString += '<infDoc>'                                      
                       
		nQtdCte:= 0
				
		aAreaSM0  := SM0->(GetArea())
		cAliasDT6 := GetNextAlias()
		cQuery := " SELECT DUD_FILDOC, DUD_DOC, DUD_SERIE, DUD_FILATU, DUD_CDRDES, DUD_CDRCAL, DUD_FILDCA, DT6_DATEMI, DT6_CHVCTE, DT6_CHVCTG, DT6_VALMER, DT6_DOCTMS, DT6_CDRCAL "
		cQuery += " FROM "
		cQuery += RetSqlName('DUD')+" DUD, "
		cQuery += RetSqlName('DT6')+" DT6  "
		cQuery += " WHERE DUD.DUD_FILIAL  = '"+xFilial("DUD")+"'"
		cQuery += "		AND DUD.DUD_FILORI  = '"+DTX->DTX_FILORI+"'"
	    If __lPyme 
			cQuery += "	  AND DUD.DUD_NUMROM  = '"+cNumRom+"'"	
        EndIf
		cQuery += "		AND DUD.DUD_FILMAN  = '"+DTX->DTX_FILMAN+"'"
		cQuery += "		AND DUD.DUD_MANIFE  = '"+DTX->DTX_MANIFE+"'"
		If lDTX_SERMAN
			cQuery += "		AND DUD.DUD_SERMAN  = '"+DTX->DTX_SERMAN+"'"
		EndIf
		cQuery += "     AND DUD.DUD_STATUS <> '" + StrZero(9,Len(DUD->DUD_STATUS)) + "'" //Cancelado
		cQuery += "		AND DUD.D_E_L_E_T_  = ' '"
		cQuery += "		AND DT6.DT6_FILIAL  = '"+xFilial("DT6")+"'"
		cQuery += "		AND DT6.DT6_FILDOC  = DUD.DUD_FILDOC "
		cQuery += "		AND DT6.DT6_DOC     = DUD.DUD_DOC"
		cQuery += "		AND DT6.DT6_SERIE   = DUD.DUD_SERIE"
		cQuery += "		AND DT6.D_E_L_E_T_  = ' '"
		If cSertms = '3' //Entrega
			cQuery += " ORDER BY DUD.DUD_CDRCAL ,DT6.DT6_AMBIEN DESC"
		Else
			cQuery += " ORDER BY DUD.DUD_FILDCA ,DT6.DT6_AMBIEN DESC"
		EndIf
		cQuery := ChangeQuery(cQuery)
		DbUseArea(.T.,'TOPCONN',TCGENQRY(,,cQuery),cAliasDT6,.T.,.T.)
		While (cAliasDT6)->(!Eof())	
			lRet:= .T.
			If Len(aTipoDoc) > 0 .And. Ascan(aTipoDoc,{|x| x == (cAliasDT6)->DT6_DOCTMS})  > 0
				lRet:= .F.
			EndIf         
			
			If lRet
				If !__lPyme 
			       If cSertms = '3' .Or. (cSertms = '2' .And. DTX->DTX_FILDCA = cFilAnt) 
						If DUY->(dbSeek(xFilial('DUY')+(cAliasDT6)->DUD_CDRCAL)) .And. DUY->DUY_CODMUN <> cMunDCAOld	
							If !Empty(cMunDCAOld)
								cString += '</infMunDescarga>'
							EndIf
							
							// Busca estado da RegiЦo de Calculo
							nEst := AScan( aUF, {|x| x[1] == DUY->DUY_EST })
							
							cString += '<infMunDescarga>'
							cString += '<cMunDescarga>' + NoAcentoCte(aUF[nEst,2] + DUY->DUY_CODMUN) + '</cMunDescarga>'
							cString += '<xMunDescarga>' + NoAcentoCte(Posicione("CC2",1, xFilial('CC2')+DUY->DUY_EST+ DUY->DUY_CODMUN,"CC2_MUN")) + '</xMunDescarga>'

						EndIf
						cMunDCAOld:= DUY->DUY_CODMUN			       		
			       Else   //Transferencia    
				       If (cAliasDT6)->DUD_FILDCA <> cFilDCAOld		
					    	If !Empty(cFilDCAOld)
								cString += '</infMunDescarga>'
							EndIf	                          
							cString += '<infMunDescarga>'
							cString += '<cMunDescarga>' + NoAcentoCte(Posicione("SM0",1,IIF(cEmpAnt+cFilAnt = "0101","0104",cEmpAnt+(cAliasDT6)->DUD_FILDCA),"M0_CODMUN")) + '</cMunDescarga>'		
							//cString += '<xMunDescarga>' + NoAcentoCte(Posicione("SM0",1,cEmpAnt+(cAliasDT6)->DUD_FILDCA,"M0_CIDENT")) + '</xMunDescarga>' //Rafael Moraes Rosa - 12/01/2023 - LINHA COMENTADA
							cString += '<xMunDescarga>' + NoAcentoCte(Posicione("SM0",1,IIF(cEmpAnt+cFilAnt = "0101","0104",cEmpAnt+(cAliasDT6)->DUD_FILDCA),"M0_CIDENT")) + '</xMunDescarga>' //Rafael Moraes Rosa - 12/01/2023 - LINHA SUBSTITUIDA
			           EndIf
				        cFilDCAOld:= (cAliasDT6)->DUD_FILDCA     
			       EndIf
		        Else // Para uso do Serie 3
				   If (cAliasDT6)->DUD_CDRCAL <> cMunDCAOld		
				    	If !Empty(cMunDCAOld)
							cString += '</infMunDescarga>'
						EndIf	                          
						
						// Em viagem de Entrega o municipio de descarga vem da DT6, regiao de Calculo
						If DUY->(MsSeek( xFilial('DUY') + (cAliasDT6)->DUD_CDRCAL ))
							// Busca estado da RegiЦo de Calculo
							nEst := AScan( aUF, {|x| x[1] == DUY->DUY_EST })

							cString += '<infMunDescarga>'
							cString += '<cMunDescarga>' + NoAcentoCte(aUF[nEst,2] + DUY->DUY_CODMUN) + '</cMunDescarga>'		
							cString += '<xMunDescarga>' + NoAcentoCte(Posicione("CC2",1, xFilial('CC2')+DUY->DUY_EST+ DUY->DUY_CODMUN,"CC2_MUN")) + '</xMunDescarga>'
						EndIf		
		           EndIf
			        cMunDCAOld:= (cAliasDT6)->DUD_CDRCAL 
		        EndIf            
		                    
				If !Empty((cAliasDT6)->DT6_CHVCTE) .Or. !Empty((cAliasDT6)->DT6_CHVCTG)
					cString += '<infCTe>'                              
					cString += '<chCTe>' + Iif(!Empty((cAliasDT6)->DT6_CHVCTE),(cAliasDT6)->DT6_CHVCTE,(cAliasDT6)->DT6_CHVCTG) + '</chCTe>'	
					                                                                                    
					If !Empty((cAliasDT6)->DT6_CHVCTG)
						cString += '<SegCodBarra>'+ Alltrim((cAliasDT6)->DT6_CHVCTG) + '</SegCodBarra>'
					EndIf	
					cString += '</infCTe>'         
					nQtdCte += 1				
				EndIf	  
			EndIf	
			(cAliasDT6)->(dbSkip())
		Enddo
		(cAliasDT6)->(dbCloseArea())		
		RestArea(aAreaSM0)
		
		cString += '</infMunDescarga>'                                              		
		cString += '</infDoc>'
		
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё TAG: Tot -- Totalizadores da carga transportada e seus doctos fiscais Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cString += '<tot>'
		If nQtdCte > 0
			cString += '<qCTe>' + cValtoChar(nQtdCte) + '</qCTe>'				
		EndIf
		
		cString += '<vCarga>'   + ConvType(DTX->DTX_VALMER, 13, 2) + '</vCarga>'
		cString += '<cUnid>01</cUnid>'			        	//01- KG, 02- TON
		cString += '<qCarga>'   + ConvType(DTX->DTX_PESO, 11, 4) + '</qCarga>'
		cString += '</tot>'

		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё TAG: Lacres -- Lacres do MDF-e                                        Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		cAliasDVB := GetNextAlias()
		cQuery := " SELECT DVB_LACRE "
		cQuery += CRLF+" FROM " + RetSqlName("DVB")	+ " DVB "
		cQuery += CRLF+" WHERE DVB_FILIAL = '" + xFilial("DVB") + "' AND "
		cQuery += CRLF+"       DVB_FILORI = '" + DTX->DTX_FILORI + "' AND "
		cQuery += CRLF+"       DVB_VIAGEM = '" + DTX->DTX_VIAGEM + "' AND "
		cQuery += CRLF+"       DVB.D_E_L_E_T_ = '' "
		cQuery := ChangeQuery(cQuery)
		dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasDVB,.F.,.T.)

		While (cAliasDVB)->(!Eof())
			cString+=	'<lacres>'
			cString+= 		'<nLacre>' + AllTrim((cAliasDVB)->DVB_LACRE) + '</nLacre>'
			cString+=	'</lacres>'
			dbskip()
		Enddo
		(cAliasDVB)->(dbCloseArea())

		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё TAG: autXML -- Autorizados para download do XML do DF-e               Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		// Conforme ResoluГЦo 799/2015 da ANTT em seu artigo 22  (Chamado TTGSCD)
		If  !Empty(cCNPJAntt)
			cString += '<autXML>'
			cString +=  '<CNPJ>' + NoPontos(cCNPJAntt) + '</CNPJ>' 
			cString += '</autXML>'
		EndIf
		//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
		//Ё TAG: infAdic -- Informacoes adicionais                                Ё
		//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
		If !Empty(cObs)                   
			cString += '<infAdic>'              
			cString +=  '<infAdFisco>' + NoAcentoCte(SubStr(cObs,1,320)) + '</infAdFisco>'
			cString += '</infAdic>'              
		EndIf
				
		cString += '</infMDFe>'
		aAdd(aXMLMDFe,AllTrim(cString))
				
		cString := ''
		cString += '</MDFe>'
				
		aAdd(aXMLMDFe,AllTrim(cString))				

		cString := ''			
		For nCount := 1 To Len(aXMLMDFe)
			cString += AllTrim(aXMLMDFe[nCount])
		Next nCount
	                                                                         
		If Empty(DTX->DTX_CHVMDF)		
		    RecLock('DTX',.F.)         
			DTX->DTX_CHVMDF:= cChvAcesso
			If cTpEmis == '2' .And.  Empty(DTX->DTX_CTGMDF)  //Contingencia
				DTX->DTX_CTGMDF:= cChvAcesso
			EndIf				
			MsUnlock()	
		EndIf                           

	EndIf
EndIf

Return({cNfe,EncodeUTF8(cString),cNumMan,cSerMan})

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁConvType  ╨Autor  ЁTotvs               ╨ Data Ё  08/03/09   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     Ё                                                            ╨╠╠
╠╠╨          Ё                                                            ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё AP                                                         ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function ConvType(xValor,nTam,nDec,lInt)

Local   cNovo := ""
Default nDec  := 0
Default lInt  := .F.

Do Case
	Case ValType(xValor)=="N"
		If lInt .And. nDec=0
			xValor := Int(xValor)
		EndIf
		cNovo := AllTrim(Str(xValor,nTam,nDec))
		If "*"$cNovo .and. nDec=0
			cNovo:= Replicate("9",nTam)
		EndIf
	Case ValType(xValor)=="D"
		cNovo := FsDateConv(xValor,"YYYYMMDD")
		cNovo := SubStr(cNovo,1,4)+"-"+SubStr(cNovo,5,2)+"-"+SubStr(cNovo,7)
	Case ValType(xValor)=="C"
		If nTam==Nil
			xValor := AllTrim(xValor)
		EndIf
		Default nTam := 60
		cNovo := NoAcentoCte(SubStr(xValor,1,nTam))
EndCase
Return(cNovo)

/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁInverte   ╨Autor  ЁTotvs               ╨ Data Ё  08/03/09   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     Ё                                                            ╨╠╠
╠╠╨          Ё                                                            ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё AP                                                         ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function Inverte(uCpo)

Local cCpo	:= uCpo
Local cRet	:= ""
Local cByte	:= ""
Local nAsc	:= 0
Local nI	:= 0
Local aChar	:= {}
Local nDiv	:= 0

aAdd(aChar,	{"0", "9"})
aAdd(aChar,	{"1", "8"})
aAdd(aChar,	{"2", "7"})
aAdd(aChar,	{"3", "6"})
aAdd(aChar,	{"4", "5"})
aAdd(aChar,	{"5", "4"})
aAdd(aChar,	{"6", "3"})
aAdd(aChar,	{"7", "2"})
aAdd(aChar,	{"8", "1"})
aAdd(aChar,	{"9", "0"})

For nI:= 1 to Len(cCpo)
	cByte := Upper(Subs(cCpo,nI,1))
	If	(Asc(cByte) >= 48 .And. Asc(cByte) <= 57) .Or. ;	// 0 a 9
		(Asc(cByte) >= 65 .And. Asc(cByte) <= 90) .Or. ;	// A a Z
		Empty(cByte)	// " "
		nAsc	:= Ascan(aChar,{|x| x[1] == cByte})
		If nAsc > 0
			cRet := cRet + aChar[nAsc,2]	// Funcao Inverte e chamada pelo rdmake de conversao
		EndIf
	Else
		// Caracteres <> letras e numeros: mantem o caracter
		cRet := cRet + cByte
	EndIf
Next
Return(cRet)
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠зддддддддддбддддддддддбдддддддбдддддддддддддддддддддддбддддддбдддддддддд©╠╠
╠╠ЁFun┤└o    Ё MDFCHVAC Ё       Ё                       Ё Data Ё02.04.2013Ё╠╠
╠╠цддддддддддеддддддддддадддддддадддддддддддддддддддддддаддддддадддддддддд╢╠╠
╠╠ЁDescri┤└o Ё Funcao responsavel em montar a Chave de Acesso             Ё╠╠
╠╠Ё          Ё a SEFAZ e calcular o seu digito verIficador.               Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠ЁSintaxe   Ё MDFCHVAC(cUF, cAAMM, cCNPJ, cMod, cSerie, nMDF, cDV)       Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё          Ё cUF...: Codigo da UF                                       Ё╠╠
╠╠Ё          Ё cAAMM.: Ano (2 Digitos) + Mes da Emissao do CTe            Ё╠╠
╠╠Ё          Ё cCNPJ.: CNPJ do Emitente do CTe                            Ё╠╠
╠╠Ё          Ё cMod..: Modelo (58 = MDFe)                                 Ё╠╠
╠╠Ё          Ё cSerie: Serie do MDFe                                      Ё╠╠
╠╠Ё          Ё nCT...: Numero do MDF                                      Ё╠╠
╠╠Ё          Ё cDV...: Numero do Lote de Envio a SEFAZ                    Ё╠╠
╠╠цддддддддддедддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╢╠╠
╠╠Ё Uso      Ё Explicacao do Calculo se encontra no manual do MDF-e       Ё╠╠
╠╠Ё          Ё disponibilizado pela SEFAZ na versao atual 1.00,           Ё╠╠
╠╠Ё          Ё pag: 68                                                    Ё╠╠
╠╠юддддддддддадддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ*/
Static Function MDFCHVAC(cUF, cAAMM, cCNPJ, cMod, cSerie, nMDF, cDV)
Local nCount      := 0
Local nSequenc    := 2
Local nPonderacao := 0
Local cResult     := ''
Local cChvAcesso  := cUF +  cAAMM + cCNPJ + cMod + cSerie + nMDF + cDV

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//ЁSEQUENCIA DE MULTIPLICADORES (nSequenc), SEGUE A SEGUINTE        Ё
//ЁORDENACAO NA SEQUENCIA: 2,3,4,5,6,7,8,9,2,3,4... E PRECISA SER   Ё
//ЁGERADO DA DIREITA PARA ESQUERDA, SEGUINDO OS CARACTERES          Ё
//ЁEXISTENTES NA CHAVE DE ACESSO INFORMADA (cChvAcesso)             Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
For nCount := Len( AllTrim(cChvAcesso) ) To 1 Step -1
	nPonderacao += ( Val( SubStr( AllTrim(cChvAcesso), nCount, 1) ) * nSequenc )
	nSequenc += 1
	If (nSequenc == 10)
		nSequenc := 2
	EndIf
Next nCount

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд©
//Ё Quando o resto da divisЦo for 0 (zero) ou 1 (um), o DV devera   Ё
//Ё ser igual a 0 (zero).                                           Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддды
If ( mod(nPonderacao,11) > 1)
	cResult := (cChvAcesso + cValToChar( (11 - mod(nPonderacao,11) ) ) )
Else
	cResult := (cChvAcesso + '0')
EndIf

Return(cResult)
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммяммммммммммммммммммммкммммммяммммммммммммм╩╠╠
╠╠╨Programa  ЁNoPontos  ╨Autor  Ё                    ╨ Data Ё  20/11/09   ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     Ё Retira caracteres dIferentes de numero, como, ponto,       ╨╠╠
╠╠╨          Ёvirgula, barra, traco                                       ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       Ё AP                                                         ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
Static Function NoPontos(cString)
Local cChar     := ""
Local nX        := 0
Local cPonto    := "."
Local cBarra    := "/"
Local cTraco    := "-"
Local cVirgula  := ","
Local cBarraInv := "\"
Local cPVirgula := ";"
Local cUnderline:= "_"
Local cParent   := "()"

For nX:= 1 To Len(cString)
	cChar := SubStr(cString, nX, 1)
	If cChar$cPonto+cVirgula+cBarra+cTraco+cBarraInv+cPVirgula+cUnderline+cParent
		cString := StrTran(cString,cChar,"")
		nX := nX - 1
	EndIf
Next
cString := AllTrim(_NoTags(cString))

Return cString

